<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Kill Chain Game</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Orbitron:wght@700&display=swap">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <div class="game-container">
        <header class="game-header">
            <div class="header-content">
                <h1>Cyber Kill Chain Game</h1>
                <p id="turn-indicator">Loading...</p>
            </div>
            <button id="new-game-btn" class="new-game-btn">New Game</button>
            <div class="kill-chain-header" id="kill-chain-header">
                <!-- Categories will be dynamically inserted here -->
            </div>
        </header>

        <div id="scoreboard">
            <h2>Scoreboard</h2>
            <ul id="teams-list">
                <!-- Teams will be dynamically inserted here -->
            </ul>
        </div>

        <main class="container">
            <div id="game-area">
                <div id="question-area">
                    <div id="turn-indicator"></div>
                    <p id="question-text"></p>
                    <p id="question-actor"></p>
                    <div id="guess-result"></div>
                </div>
            </div>
            <div id="win-screen" style="display: none;">
                <h1 id="winner-message"></h1>
                <h2>Final Scores</h2>
                <ul id="final-scores">
                    <!-- Final scores will be dynamically inserted here -->
                </ul>
            </div>
        </main>
    </div>

    <script>
        const socket = io();

        socket.on('connect', () => {
            console.log('Connected to server');
            socket.emit('get_game_state');
        });

        socket.on('redirect_to_home', () => {
            window.location.href = "{{ url_for('home') }}";
        });

        socket.on('game_state_update', (data) => {
            console.log('Game state update:', data);
            updateScoreboard(data.teams);
            updateTurnIndicator(data.current_turn);
            updateQuestion(data.current_question);
            updateCategories(data.categories);
            if (data.game_over) {
                showWinScreen(data.winner, data.teams);
            }
        });

        socket.on('guess_result', (data) => {
            const resultDiv = document.getElementById('guess-result');
            if (data.correct) {
                resultDiv.textContent = `Correct! Point for ${data.team}.`;
                resultDiv.className = 'correct';
            } else {
                resultDiv.textContent = `Incorrect. Next team's turn.`;
                resultDiv.className = 'incorrect';
            }
        });

        socket.on('game_over', (data) => {
            showWinScreen(data.winner, data.teams);
        });

        function updateScoreboard(teams) {
            const teamsList = document.getElementById('teams-list');
            teamsList.innerHTML = '';
            for (const team in teams) {
                const li = document.createElement('li');
                li.textContent = `${team}: ${teams[team]}`;
                teamsList.appendChild(li);
            }
        }

        function updateTurnIndicator(currentTurn) {
            const turnDiv = document.getElementById('turn-indicator');
            if (currentTurn) {
                turnDiv.textContent = `It's ${currentTurn}'s turn to answer.`;
            }
        }

        function updateQuestion(question) {
            const questionText = document.getElementById('question-text');
            const questionActor = document.getElementById('question-actor');
            if (question) {
                questionText.textContent = `Scenario: ${question.scenario}`;
                questionActor.textContent = `Threat Actor: ${question.actor}`;
                document.getElementById('guess-result').textContent = '';
            } else {
                questionText.textContent = 'Waiting for game to start...';
                questionActor.textContent = '';
            }
        }
        
        function updateCategories(categories) {
            const header = document.getElementById('kill-chain-header');
            header.innerHTML = '';
            categories.forEach(category => {
                const span = document.createElement('span');
                span.textContent = category;
                span.onclick = () => submitGuess(category);
                header.appendChild(span);
            });
        }

        function submitGuess(guess) {
            socket.emit('submit_guess', { 'guess': guess });
        }

        function showWinScreen(winner, teams) {
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('win-screen').style.display = 'block';
            document.getElementById('winner-message').textContent = `${winner} wins the game!`;
            
            const finalScoresList = document.getElementById('final-scores');
            finalScoresList.innerHTML = '';
            for (const team in teams) {
                const li = document.createElement('li');
                li.textContent = `${team}: ${teams[team]}`;
                finalScoresList.appendChild(li);
            }
        }

        const newGameBtn = document.getElementById('new-game-btn');

        newGameBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to start a new game? Current progress will be lost.')) {
                socket.emit('new_game');
            }
        });

    </script>
</body>
</html> 